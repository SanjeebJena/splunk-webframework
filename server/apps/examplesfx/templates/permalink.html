{% extends "splunkdj:base_with_app_bar.html" %}

{% load splunkmvc %}

{% block title %}{{app_name}} Home Page{% endblock title %}

{% block css %}
    <link rel="stylesheet" type="text/css" href="{{STATIC_URL}}splunkjs/css/dashboard.css">
{% endblock css %}

{% block content %}

<div class="dashboard-body container-fluid main-section-body" data-role="main">
    <div class="row">
        <div class="span12 dashboard-header clearfix">
            <h2>Permalinking</h2>
        </div>
    </div>
    <div class="dashboard-row">
        <div class="dashboard-cell" style="width: 100%;">
            <div class="dashboard-panel">
                <div class="dashboard-element">
                    <div class="panel-head">
                    </div>
                    <div class="panel-body">
                        <p>
                        There are many ways to support permalinking. In this example,
                        we show one particular way, where state (in this case, the
                        <code>sourcetype</code> and <code>index</code> values) is
                        stored as part of the URL as query arguments.
                        With that state loaded, we set it on the managers and start
                        the searches.
                        </p>
                        
                        <p>
                        Other possibilities for permalinking could include using the
                        Django URL dispatcher to encode state in the URL and pass that
                        to JavaScript (or use it in Python), using a JavaScript URL
                        router (such as <code>Backbone.Router</code>).
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="dashboard-row">
        <div class="dashboard-cell" style="width: 50%;">
            <div class="dashboard-panel">
                <div class="dashboard-element">
                    <div class="panel-head">
                        <h3>Chart 1</h3>
                    </div>
                    <div class="panel-body">
                        {% chart id="chart1" managerid="search1" type="line" %}
                    </div>
                </div>
            </div>
        </div>
        <div class="dashboard-cell" style="width: 50%;">
            <div class="dashboard-panel">
                <div class="dashboard-element">
                    <div class="panel-head">
                        <h3>Chart 2</h3>
                    </div>
                    <div class="panel-body">
                        {% chart id="chart2" managerid="search2" type="line" %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="dashboard-row">
        <div class="dashboard-cell" style="width: 100%;">
            <div class="dashboard-panel">
                <div class="dashboard-element">
                    <div class="panel-head">
                        <h3>My Table</h3>
                    </div>
                    <div class="panel-body">
                        {% resulttable id="table1" managerid="search1" %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock content%}

{% block managers %}
    {% searchmanager id="search1" search="index=_internal sourcetype=$sourcetype$ | timechart count" 
        preview=True cache=60 earliest_time="-1h" autostart=False %}
        
    {% searchmanager id="search2" search="index=$index$ | head 1000 | timechart count" 
        preview=True cache=60 autostart=False %}
{% endblock managers %}

{% block js %}
<script>
    require(["splunkjs/ready!"], function(mvc) {
        var queryArgs = window.location.search.substr(1) || "";
        var params = $.deparam(queryArgs) || {};
        
        var sourcetype = params.sourcetype;
        var index = params.index;
        
        console.log(params);
        
        var search1 = mvc.Components.getInstance("search1");
        var search2 = mvc.Components.getInstance("search2");
        
        // Set the values on the searches, and since we told the managers to 
        // not autostart, we need to start them.
        if (sourcetype) {
            search1.query.set("sourcetype", sourcetype);
            search1.startSearch();
        }
        if (index) {
            search2.query.set("index", index);
            search2.startSearch();
        }
    });
</script>
{% endblock js %}
